name: CI - Minikube local deploy and integration tests

on:
  workflow_dispatch:
  workflow_call: {}

jobs:
  minikube-deploy:
    name: Start Minikube and deploy
    runs-on: ubuntu-latest
    outputs:
      deployed: ${{ steps.check_deploy.outcome }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Minikube
        uses: manusa/actions-setup-minikube@v2.5.0
        with:
          kubernetes-version: '1.24.0'
          minikube-version: '1.30.0'
          driver: docker

      - name: Use minikube docker daemon
        run: |
          echo "Switching docker to minikube daemon"
          eval $(minikube -p minikube docker-env)

      - name: Build Docker image
        run: |
          docker build -t univ-soa:ci .

      - name: Apply Kubernetes manifests
        run: |
          # apply namespace if exists
          kubectl apply -f k8s/namespace.yaml --ignore-not-found=true || true
          # prefer helm manifests if present, fallback to k8s manifests
          if [ -d "helm/smartdish/manifests" ]; then
            kubectl apply -f helm/smartdish/manifests --recursive || true
          else
            kubectl apply -f k8s/ --recursive || true
          fi

      - name: Wait for deployment (short)
        id: check_deploy
        run: |
          set -e
          kubectl -n soa-integration rollout status deployment/univ-soa --timeout=120s || exit 0

  integration-tests:
    name: Integration tests (newman)
    needs: minikube-deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install test dependencies
        working-directory: tests/newman
        run: npm ci

      - name: Port-forward service to localhost
        run: |
          kubectl -n soa-integration port-forward svc/univ-soa 8090:8090 &
          sleep 5

      - name: Run integration tests
        working-directory: tests/newman
        run: node index.js --collection ./collection.json --env ./env.json --data ./dataset.json
