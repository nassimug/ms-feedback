name: Check Coverage

on:
  workflow_call:

jobs:
  check-coverage:
    name: Check Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven

      - name: Run tests and generate JaCoCo report
        run: |
          echo "ğŸ“Š Running tests and generating coverage report..."
          mvn -B clean test jacoco:report

      - name: Extract and display exact coverage
        run: |
          echo "ğŸ” Extracting coverage from report..."
          if [ -f target/site/jacoco/jacoco.xml ]; then
            python3 - << 'PY'
import xml.etree.ElementTree as ET
xml_path = 'target/site/jacoco/jacoco.xml'
root = ET.parse(xml_path).getroot()
# Aggregate LINE counters
covered_total = 0
missed_total = 0
for counter in root.findall('.//counter'):
    if counter.get('type') == 'LINE':
        covered_total += int(counter.get('covered', '0'))
        missed_total += int(counter.get('missed', '0'))

total = covered_total + missed_total
pct = (covered_total * 100.0 / total) if total > 0 else 0.0
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
print("ğŸ“ˆ JACOCO COVERAGE SUMMARY")
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
print(f"âœ… Line Coverage: {pct:.2f}%")
print("ğŸ“‹ Required Minimum: 60%")
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
if pct < 60.0:
    import sys
    print(f"âŒ Coverage {pct:.2f}% is below minimum 60%")
    sys.exit(1)
PY
          else
            echo "âŒ Coverage XML report not found: target/site/jacoco/jacoco.xml"
            exit 1
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: target/site/jacoco/
          retention-days: 7
