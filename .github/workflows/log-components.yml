name: Log Components URLs

on:
  workflow_call:

jobs:
  log-urls:
    name: Log All Component URLs
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    steps:
      - name: Configure kubectl
        run: |
          mkdir -p ~/.kube
          minikube kubectl -- config view --raw > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Get all service URLs
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ðŸŒ COMPONENTS ACCESS URLS                    â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Get namespace
          NAMESPACE="soa-integration"
          
          echo "ðŸ“‹ Namespace: $NAMESPACE"
          echo ""
          
          # List all services
          echo "ðŸ”§ Services in namespace:"
          kubectl get svc -n $NAMESPACE -o wide
          echo ""
          
          # Get Minikube IP
          MINIKUBE_IP=$(minikube ip)
          echo "ðŸ–¥ï¸  Minikube IP: $MINIKUBE_IP"
          echo ""
          
          # Get univ-soa service
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸš€ API Service (univ-soa)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          NODE_PORT=$(kubectl get svc univ-soa -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "N/A")
          if [ "$NODE_PORT" != "N/A" ]; then
            API_URL="http://${MINIKUBE_IP}:${NODE_PORT}"
            echo "âœ… URL: $API_URL"
            echo "ðŸ“ Health: $API_URL/actuator/health"
            echo "ðŸ“ Info: $API_URL/actuator/info"
            echo "ðŸ“ Database Test: $API_URL/api/database/test"
          else
            echo "âŒ Service not found or not exposed"
          fi
          echo ""
          
          # Get phpMyAdmin service
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ’¾ phpMyAdmin (MySQL Management)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          PMA_PORT=$(kubectl get svc phpmyadmin -n $NAMESPACE -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "N/A")
          if [ "$PMA_PORT" != "N/A" ]; then
            PMA_URL="http://${MINIKUBE_IP}:${PMA_PORT}"
            echo "âœ… URL: $PMA_URL"
            echo "ðŸ‘¤ Username: root"
            echo "ðŸ”‘ Password: password"
          else
            echo "âŒ Service not found or not exposed"
          fi
          echo ""
          
          # Get MySQL service (internal only)
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ—„ï¸  MySQL Database (Internal)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“ Host: mysql.$NAMESPACE.svc.cluster.local"
          echo "ðŸ“ Port: 3306"
          echo "ðŸ“ Database: testdb"
          echo "ðŸ‘¤ Username: root / sa"
          echo "ðŸ”‘ Password: password"
          echo ""
          
          # Check ArgoCD (if installed)
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”„ ArgoCD (GitOps - if installed)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ARGOCD_PORT=$(kubectl get svc argocd-server -n argocd -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "N/A")
          if [ "$ARGOCD_PORT" != "N/A" ]; then
            ARGOCD_URL="http://${MINIKUBE_IP}:${ARGOCD_PORT}"
            echo "âœ… URL: $ARGOCD_URL"
            echo "ðŸ‘¤ Username: admin"
            echo "ðŸ”‘ Password: (run: kubectl get secret argocd-initial-admin-secret -n argocd -o jsonpath='{.data.password}' | base64 -d)"
          else
            echo "â„¹ï¸  Not installed in this environment"
          fi
          echo ""
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ðŸ“Š CLUSTER STATUS                            â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Pods status
          echo "ðŸ” Pods Status:"
          kubectl get pods -n $NAMESPACE -o wide
          echo ""
          
          # Deployments status
          echo "ðŸ“¦ Deployments Status:"
          kubectl get deployments -n $NAMESPACE
          echo ""
          
          echo "âœ… Component URLs logged successfully!"

      - name: Save URLs to artifact
        run: |
          MINIKUBE_IP=$(minikube ip)
          NODE_PORT=$(kubectl get svc univ-soa -n soa-integration -o jsonpath='{.spec.ports[0].nodePort}')
          PMA_PORT=$(kubectl get svc phpmyadmin -n soa-integration -o jsonpath='{.spec.ports[0].nodePort}' 2>/dev/null || echo "N/A")
          
          cat > component-urls.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          ðŸŒ COMPONENTS ACCESS INFORMATION             â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸš€ API Service: http://${MINIKUBE_IP}:${NODE_PORT}
          ðŸ“ Health Check: http://${MINIKUBE_IP}:${NODE_PORT}/actuator/health
          ðŸ“ Database Test: http://${MINIKUBE_IP}:${NODE_PORT}/api/database/test
          
          ðŸ’¾ phpMyAdmin: http://${MINIKUBE_IP}:${PMA_PORT}
          ðŸ‘¤ Username: root
          ðŸ”‘ Password: password
          
          ðŸ—„ï¸  MySQL (Internal):
          ðŸ“ Host: mysql.soa-integration.svc.cluster.local:3306
          ðŸ“ Database: testdb
          ðŸ‘¤ Username: root / sa
          ðŸ”‘ Password: password
          
          ðŸ–¥ï¸  Minikube IP: ${MINIKUBE_IP}
          EOF
          
          cat component-urls.txt

      - name: Upload URLs artifact
        uses: actions/upload-artifact@v4
        with:
          name: component-urls
          path: component-urls.txt
          retention-days: 7

