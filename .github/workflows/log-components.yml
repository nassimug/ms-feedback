name: Log Components URLs

on:
  workflow_call:

jobs:
  log-urls:
    name: Log All Component URLs
    runs-on: ubuntu-22.04
    timeout-minutes: 5
    steps:
      - name: Download service URL artifact
        uses: actions/download-artifact@v4
        with:
          name: service-url
          path: ./

      - name: Download service URL artifact (with health)
        uses: actions/download-artifact@v4
        with:
          name: service-url-artifact
          path: ./
        continue-on-error: true

      - name: Display all component URLs
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ðŸŒ DEPLOYED COMPONENTS INFORMATION           â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          
          # Read the main service URL
          if [ -f "service-url.txt" ]; then
            SERVICE_URL=$(cat service-url.txt)
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸš€ API Service (univ-soa)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… URL: $SERVICE_URL"
            echo "ðŸ“ Health: ${SERVICE_URL}/actuator/health"
            echo "ðŸ“ Info: ${SERVICE_URL}/actuator/info"
            echo "ðŸ“ Database Test: ${SERVICE_URL}/api/database/test"
            echo ""
          else
            echo "âŒ Service URL not found!"
            echo ""
          fi
          
          # Extract IP and port if available
          if [ -f "service-url.txt" ]; then
            MINIKUBE_IP=$(echo $SERVICE_URL | sed -n 's|http://\([^:]*\):.*|\1|p')
            API_PORT=$(echo $SERVICE_URL | sed -n 's|http://[^:]*:\([0-9]*\).*|\1|p')
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ’¾ phpMyAdmin (MySQL Management)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â„¹ï¸  Deployed in namespace: soa-integration"
            echo "â„¹ï¸  To access, run port-forward:"
            echo "   kubectl port-forward svc/phpmyadmin 8081:80 -n soa-integration"
            echo "   Then access: http://localhost:8081"
            echo "ðŸ‘¤ Username: root"
            echo "ðŸ”‘ Password: password"
            echo ""
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ—„ï¸  MySQL Database (Internal)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“ Host: mysql.soa-integration.svc.cluster.local"
            echo "ðŸ“ Port: 3306"
            echo "ðŸ“ Database: testdb"
            echo "ðŸ‘¤ Username: root / sa"
            echo "ðŸ”‘ Password: password"
            echo ""
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ–¥ï¸  Minikube Cluster"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ“ IP: $MINIKUBE_IP"
            echo "ðŸ“ Namespace: soa-integration"
            echo ""
          fi
          
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘          ðŸ“Š SUMMARY                                   â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "âœ… API Service deployed and accessible"
          echo "âœ… MySQL database running"
          echo "âœ… phpMyAdmin available (use port-forward)"
          echo ""
          echo "ðŸ“‹ To interact with the cluster from your local machine:"
          echo "   1. Install kubectl and minikube"
          echo "   2. Configure context to use the deployed cluster"
          echo "   3. Run: kubectl get all -n soa-integration"
          echo ""

      - name: Create comprehensive URLs artifact
        run: |
          SERVICE_URL=$(cat service-url.txt 2>/dev/null || echo "N/A")
          MINIKUBE_IP=$(echo $SERVICE_URL | sed -n 's|http://\([^:]*\):.*|\1|p')
          
          cat > component-urls.txt << EOF
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘          ðŸŒ COMPONENTS ACCESS INFORMATION             â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ðŸš€ API Service: $SERVICE_URL
          ðŸ“ Health Check: ${SERVICE_URL}/actuator/health
          ðŸ“ Database Test: ${SERVICE_URL}/api/database/test
          
          ðŸ’¾ phpMyAdmin:
          â„¹ï¸  Use port-forward: kubectl port-forward svc/phpmyadmin 8081:80 -n soa-integration
          â„¹ï¸  Then access: http://localhost:8081
          ðŸ‘¤ Username: root
          ðŸ”‘ Password: password
          
          ðŸ—„ï¸  MySQL (Internal):
          ðŸ“ Host: mysql.soa-integration.svc.cluster.local:3306
          ðŸ“ Database: testdb
          ðŸ‘¤ Username: root / sa
          ðŸ”‘ Password: password
          
          ðŸ–¥ï¸  Cluster Info:
          ðŸ“ Namespace: soa-integration
          ðŸ“ Minikube IP: $MINIKUBE_IP
          
          ðŸ“‹ Useful commands:
          - Get all resources: kubectl get all -n soa-integration
          - View logs: kubectl logs -n soa-integration deployment/univ-soa
          - Access MySQL: kubectl port-forward svc/mysql 3306:3306 -n soa-integration
          EOF
          
          cat component-urls.txt

      - name: Upload URLs artifact
        uses: actions/upload-artifact@v4
        with:
          name: component-urls
          path: component-urls.txt
          retention-days: 7

