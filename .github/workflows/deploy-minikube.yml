name: Deploy to Minikube (manual)

on:
  workflow_dispatch:

jobs:
  deploy-minikube:
    name: Deploy to Minikube
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Minikube
        uses: manusa/actions-setup-minikube@v2.5.0
        with:
          kubernetes-version: '1.24.0'
          minikube-version: '1.30.0'
          driver: docker

      - name: Use minikube docker daemon
        run: |
          echo "Switching docker to minikube daemon"
          eval $(minikube -p minikube docker-env)

      - name: Build Docker image
        run: |
          docker build -t univ-soa:local .

      - name: Create namespace
        run: |
          kubectl create namespace soa-integration --dry-run=client -o yaml | kubectl apply -f -

      - name: Apply manifests
        run: |
          if [ -d "helm/smartdish/manifests" ]; then
            kubectl apply -f helm/smartdish/manifests --recursive || true
          else
            kubectl apply -f k8s/ --recursive || true
          fi

      - name: Override image to local built image
        run: |
          # Ensure deployment exists first
          if kubectl -n soa-integration get deployment univ-soa >/dev/null 2>&1; then
            kubectl -n soa-integration set image deployment/univ-soa univ-soa=univ-soa:local --record || true
          else
            echo "Deployment univ-soa not found; manifests might create it on apply"
          fi

      - name: Wait for rollout
        run: |
          kubectl -n soa-integration rollout status deployment/univ-soa --timeout=300s || kubectl -n soa-integration get pods -o wide || true

      - name: Show pods
        run: |
          kubectl -n soa-integration get pods -o wide

