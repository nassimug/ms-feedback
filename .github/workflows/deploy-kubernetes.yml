name: Deploy Kubernetes

on:
  workflow_call:
    inputs:
      image-tag:
        required: true
        type: string
    outputs:
      service-url:
        description: "Service URL"
        value: ${{ jobs.deploy.outputs.service-url }}

env:
  IMAGE_NAME: univ-soa
  NAMESPACE: soa-integration

jobs:
  deploy:
    name: Deploy to Kubernetes (Minikube)
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    outputs:
      service-url: ${{ steps.endpoint.outputs.service_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: ./

      - name: Setup Minikube
        uses: manusa/actions-setup-minikube@v2.10.0
        with:
          minikube version: '1.32.0'
          kubernetes version: '1.28.0'
          driver: docker
          start args: '--memory=4096 --cpus=2'

      - name: Verify Minikube
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Load Docker image into Minikube
        run: |
          eval $(minikube docker-env)
          docker load -i app-image.tar
          docker images | grep ${{ env.IMAGE_NAME }}

      - name: Create namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy application to Minikube
        run: |
          kubectl apply -f k8s/minikube/ -n ${{ env.NAMESPACE }}

      - name: Update deployment image
        run: |
          kubectl set image deployment/univ-soa \
            univ-soa=${{ env.IMAGE_NAME }}:${{ inputs.image-tag }} \
            -n ${{ env.NAMESPACE }}
          echo "âœ… Deployment updated with image tag: ${{ inputs.image-tag }}"

      - name: Wait for deployment
        run: |
          kubectl rollout status deployment/univ-soa -n ${{ env.NAMESPACE }} --timeout=300s
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide

      - name: Get service endpoint
        id: endpoint
        run: |
          kubectl wait --for=condition=ready pod -l app=univ-soa -n ${{ env.NAMESPACE }} --timeout=300s
          SERVICE_URL=$(minikube service univ-soa --url -n ${{ env.NAMESPACE }} 2>/dev/null || echo "")
          if [ -z "$SERVICE_URL" ]; then
            MINIKUBE_IP=$(minikube ip)
            NODEPORT=$(kubectl get svc univ-soa -n ${{ env.NAMESPACE }} -o jsonpath='{.spec.ports[0].nodePort}')
            SERVICE_URL="http://$MINIKUBE_IP:$NODEPORT"
          fi
          echo "service_url=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "Service accessible at: $SERVICE_URL"

      - name: Test service health
        run: |
          curl -f ${{ steps.endpoint.outputs.service_url }}/actuator/health || \
          curl -f ${{ steps.endpoint.outputs.service_url }}/health || \
          curl -f ${{ steps.endpoint.outputs.service_url }}/ || \
          echo "Health check endpoint not available"

      - name: Upload service URL artifact
        run: |
          echo "${{ steps.endpoint.outputs.service_url }}" > service-url.txt

      - name: Upload service URL
        uses: actions/upload-artifact@v4
        with:
          name: service-url
          path: service-url.txt
          retention-days: 1

