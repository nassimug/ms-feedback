name: Integration Tests

on:
  workflow_call:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: string
      service-url:
        description: 'Service URL to test'
        required: false
        type: string
    secrets:
      GITHUB_TOKEN:
        required: true

jobs:
  newman-tests:
    name: Run Newman integration tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup Minikube
        uses: medyagh/setup-minikube@latest
        with:
          driver: docker
          cpus: 2
          memory: 2048m
          kubernetes-version: v1.28.0

      - name: Set service URL
        run: |
          echo "SERVICE_URL=${{ inputs.service-url || 'http://localhost:8080' }}" >> $GITHUB_ENV

      - name: Verify deployment status
        run: |
          echo "ğŸ“Š Checking deployment status..."
          
          # VÃ©rifier que tous les pods sont READY
          kubectl get pods -n soa-integration
          
          # Attendre que univ-soa soit ready (max 3 minutes)
          kubectl wait --for=condition=ready pod \
            -l app=univ-soa \
            -n soa-integration \
            --timeout=180s
          
          # VÃ©rifier les logs du pod
          POD_NAME=$(kubectl get pods -n soa-integration -l app=univ-soa -o jsonpath='{.items[0].metadata.name}')
          echo "ğŸ“‹ Derniers logs du pod $POD_NAME:"
          kubectl logs $POD_NAME -n soa-integration --tail=20
          
          # VÃ©rifier le service
          kubectl get svc univ-soa -n soa-integration
          kubectl describe svc univ-soa -n soa-integration

      - name: Setup port-forward
        run: |
          echo "ğŸ”Œ Setting up port-forward..."
          
          # Port-forward en arriÃ¨re-plan
          kubectl port-forward svc/univ-soa 8080:8080 -n soa-integration &
          PORT_FORWARD_PID=$!
          echo "port_forward_pid=$PORT_FORWARD_PID" >> $GITHUB_ENV
          
          # Attendre que le port-forward soit prÃªt
          sleep 5
          
          # Tester la connexion locale
          for i in {1..12}; do
            if curl -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "âœ… Port-forward ready!"
              break
            fi
            echo "â³ Waiting for port-forward ($i/12)..."
            sleep 5
          done

      - name: Install Newman
        working-directory: ./tests/newman
        run: |
          echo "ğŸ“¦ Installing Newman..."
          npm install

      - name: Update environment with localhost URL
        working-directory: ./tests/newman
        run: |
          echo "ğŸ“ Using localhost:8080 for tests..."
          jq --arg url "http://localhost:8080" \
            '(.values[] | select(.key == "baseUrl") | .value) = $url' \
            env.json > env.tmp.json
          
          cat env.tmp.json

      - name: Test connectivity
        run: |
          echo "ğŸ”Œ Testing connectivity to localhost:8080..."
          
          # Test health endpoint
          curl -v --connect-timeout 10 --max-time 30 "http://localhost:8080/actuator/health" || {
            echo "âŒ Cannot reach service on localhost:8080"
            kubectl get pods -n soa-integration
            kubectl logs -l app=univ-soa -n soa-integration --tail=50
            exit 1
          }
          
          echo "âœ… Service is reachable!"

      - name: Run Newman integration tests
        working-directory: ./tests/newman
        run: |
          echo "ğŸš€ Starting Newman tests..."
          echo "ğŸ“‹ Current directory: $(pwd)"
          npx newman --version || npm install -g newman
          
          # ExÃ©cuter les tests
          npx newman run ./collection.json \
            --environment ./env.tmp.json \
            --iteration-data ./dataset.json \
            --reporters cli,json \
            --reporter-json-export ./newman-results/newman-report.json \
            --bail || {
              echo "âŒ Newman tests failed!"
              echo "ğŸ“Š Checking service status..."
              curl -v "http://localhost:8080/actuator/health" || true
              kubectl logs -l app=univ-soa -n soa-integration --tail=100
              exit 1
            }
          
          echo "âœ… Newman tests passed!"

      - name: Upload Newman results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: newman-results
          path: tests/newman/newman-results/

      - name: Cleanup port-forward
        if: always()
        run: |
          if [ ! -z "${{ env.port_forward_pid }}" ]; then
            kill ${{ env.port_forward_pid }} || true
          fi
